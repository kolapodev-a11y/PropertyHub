<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Post a Listing ‚Äî PropertyHub</title>
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/listing.css" />
  <!-- Google Maps API ‚Äî replace YOUR_MAPS_API_KEY -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=YOUR_MAPS_API_KEY&libraries=places&callback=initMapsCallback"
    defer async>
  </script>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar">
  <div class="nav-inner">
    <a href="index.html" class="nav-logo">
      <svg viewBox="0 0 40 40" fill="none"><rect width="40" height="40" rx="10" fill="#006AFF"/><path d="M20 8L8 18V32H16V24H24V32H32V18L20 8Z" fill="white"/></svg>
      Property<span>Hub</span>
    </a>
    <button class="mobile-menu-toggle" id="mobile-menu-toggle"><span></span><span></span><span></span></button>
    <ul class="nav-menu" id="nav-menu">
      <li><a href="buy-phone.html">üì± Buy Phone</a></li>
      <li><a href="sell-land.html">üåç Sell Land</a></li>
      <li><a href="rent-house.html">üè† Rent House</a></li>
      <li><a href="sell-house.html">üè° Sell House</a></li>
    </ul>
    <div class="nav-auth">
      <a href="login.html"    class="btn-outline" id="nav-login">Login</a>
      <a href="register.html" class="btn-primary"  id="nav-register">Sign Up</a>
      <div class="user-menu" id="nav-user-menu" style="display:none;">
        <div class="user-avatar-wrap"><img id="nav-avatar" src="" alt="avatar" /></div>
        <span id="nav-username" class="user-name"></span>
        <button id="nav-logout">Logout</button>
      </div>
    </div>
  </div>
</nav>

<!-- UPLOAD PAGE -->
<div class="upload-page">
  <div class="upload-container">
    <div class="upload-header">
      <h1>üìù Post a New Listing</h1>
      <p>Fill in the details below. Your listing will appear on the map for buyers to discover.</p>
    </div>

    <div class="upload-form-body">
      <form id="upload-form" novalidate>

        <!-- ‚îÄ‚îÄ SECTION 1: Basic Info ‚îÄ‚îÄ -->
        <div class="form-section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
          Basic Information
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="title">Listing Title <span class="req">*</span></label>
            <input type="text" id="title" class="form-input" placeholder="e.g. 3-bedroom apartment in Lekki" required />
          </div>
          <div class="form-group">
            <label class="form-label" for="category">Category <span class="req">*</span></label>
            <select id="category" class="form-select" required>
              <option value="" disabled selected>Select a category‚Ä¶</option>
              <option value="phone">üì± Buy / Sell Phone</option>
              <option value="land">üåç Land for Sale</option>
              <option value="rent">üè† House for Rent</option>
              <option value="sell_house">üè° House for Sale</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="price">Price (USD) <span class="req">*</span></label>
            <div class="input-prefix">
              <span class="input-prefix-icon">$</span>
              <input type="number" id="price" class="form-input" placeholder="e.g. 250000" min="0" required />
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" for="contact">Contact (Phone / WhatsApp)</label>
            <input type="tel" id="contact" class="form-input" placeholder="+1 234 567 8900" />
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="description">Description <span class="req">*</span></label>
          <textarea id="description" class="form-textarea" placeholder="Describe your listing in detail‚Ä¶ (size, condition, amenities, etc.)" required></textarea>
        </div>

        <!-- ‚îÄ‚îÄ SECTION 2: Images ‚îÄ‚îÄ -->
        <div class="form-section-title" style="margin-top:32px;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
          Photos
        </div>

        <div class="image-upload-area" id="upload-area">
          <div class="upload-icon">üì∏</div>
          <h4>Drag & drop photos here</h4>
          <p>or <span class="browse-link" id="browse-link">browse from your device</span></p>
          <p style="margin-top:8px; font-size:.75rem; color:var(--text-muted);">JPG, PNG, WebP ‚Ä¢ Max 5MB per image ‚Ä¢ Up to 10 photos</p>
        </div>
        <input type="file" id="img-input" accept="image/*" multiple />
        <div class="img-preview" id="img-preview"></div>

        <!-- ‚îÄ‚îÄ SECTION 3: Location ‚îÄ‚îÄ -->
        <div class="form-section-title" style="margin-top:32px;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
          Location
        </div>

        <div class="form-group">
          <label class="form-label" for="location-input">
            Search Location <span class="req">*</span>
            <span style="font-weight:400; color:var(--text-muted); font-size:.78rem; margin-left:8px;">Start typing to see suggestions</span>
          </label>
          <div style="position:relative;">
            <svg style="position:absolute; left:14px; top:50%; transform:translateY(-50%); color:var(--text-muted); pointer-events:none;" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
            <input type="text" id="location-input" class="form-input" placeholder="e.g. 123 Main St, Lagos, Nigeria" style="padding-left:42px;" autocomplete="off" />
          </div>
          <p style="font-size:.78rem; color:var(--text-muted); margin-top:5px;">üìç Select from the dropdown to pin on map</p>
        </div>

        <!-- Google Map Preview -->
        <div id="upload-map"></div>

        <!-- Submit -->
        <div class="submit-row">
          <button type="button" class="btn-cancel" onclick="history.back()">Cancel</button>
          <button type="submit" id="submit-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 2L11 13"/><path d="M22 2L15 22 11 13 2 9l20-7z"/></svg>
            Post Listing
          </button>
        </div>

      </form>
    </div>
  </div>
</div>

<script>
  // Called when Google Maps API is ready
  window.initMapsCallback = function() {
    window.mapsReady = true;
    if (window.pendingMapInit) window.pendingMapInit();
  };
</script>

<script type="module">
  import { setupNavAuth, requireAuth } from "./js/auth.js";
  import { addListing, uploadImages } from "./js/listings.js";

  setupNavAuth();
  const toggle = document.getElementById("mobile-menu-toggle");
  const navMenu = document.getElementById("nav-menu");
  if (toggle) toggle.addEventListener("click", () => navMenu.classList.toggle("open"));

  // Require authentication
  await requireAuth("login.html");

  // Preset category from URL
  const urlParams   = new URLSearchParams(window.location.search);
  const presetCat   = urlParams.get("cat");
  const catSelect   = document.getElementById("category");
  if (presetCat && catSelect) catSelect.value = presetCat;

  // ‚îÄ‚îÄ Image Upload ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let selectedFiles = [];
  const imgInput    = document.getElementById("img-input");
  const preview     = document.getElementById("img-preview");
  const uploadArea  = document.getElementById("upload-area");
  const browseLink  = document.getElementById("browse-link");

  browseLink.addEventListener("click", () => imgInput.click());
  uploadArea.addEventListener("click", () => imgInput.click());

  // Drag & Drop
  uploadArea.addEventListener("dragover", (e) => { e.preventDefault(); uploadArea.classList.add("dragover"); });
  uploadArea.addEventListener("dragleave", () => uploadArea.classList.remove("dragover"));
  uploadArea.addEventListener("drop", (e) => {
    e.preventDefault(); uploadArea.classList.remove("dragover");
    handleFiles(Array.from(e.dataTransfer.files).filter(f => f.type.startsWith("image/")));
  });

  imgInput.addEventListener("change", (e) => handleFiles(Array.from(e.target.files)));

  function handleFiles(files) {
    files.forEach(file => {
      if (file.size > 5 * 1024 * 1024) { showToast(`${file.name} exceeds 5MB limit.`, "error"); return; }
      if (selectedFiles.length >= 10)   { showToast("Maximum 10 photos allowed.", "warning"); return; }
      selectedFiles.push(file);
      const reader = new FileReader();
      reader.onload = (ev) => {
        const idx     = selectedFiles.length - 1;
        const wrapper = document.createElement("div");
        wrapper.className = "preview-item";
        wrapper.dataset.index = idx;
        wrapper.innerHTML = `
          <img src="${ev.target.result}" alt="preview" />
          <button type="button" class="remove-img" data-index="${idx}">‚úï</button>`;
        preview.appendChild(wrapper);
      };
      reader.readAsDataURL(file);
    });
  }

  preview.addEventListener("click", (e) => {
    if (e.target.classList.contains("remove-img")) {
      const idx = parseInt(e.target.dataset.index);
      selectedFiles.splice(idx, 1);
      const item = e.target.closest(".preview-item");
      if (item) item.remove();
      // Re-index
      preview.querySelectorAll(".preview-item").forEach((el, i) => {
        el.dataset.index = i;
        const btn = el.querySelector(".remove-img");
        if (btn) btn.dataset.index = i;
      });
    }
  });

  // ‚îÄ‚îÄ Location & Map ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let selectedLat   = null;
  let selectedLng   = null;
  let selectedPlace = "";
  let uploadMap     = null;
  let uploadMarker  = null;

  function initUploadMap() {
    const mapEl = document.getElementById("upload-map");
    if (!mapEl || !window.google) return;

    uploadMap = new google.maps.Map(mapEl, {
      center: { lat: 6.5244, lng: 3.3792 }, // Lagos default
      zoom: 10,
      mapTypeControl: false
    });

    const locationInput = document.getElementById("location-input");
    const autocomplete  = new google.maps.places.Autocomplete(locationInput, {
      types: ["geocode", "establishment"]
    });
    autocomplete.bindTo("bounds", uploadMap);

    autocomplete.addListener("place_changed", () => {
      const place = autocomplete.getPlace();
      if (!place.geometry || !place.geometry.location) {
        showToast("Please select a location from the dropdown.", "error");
        return;
      }
      selectedPlace = place.formatted_address || place.name || locationInput.value;
      selectedLat   = place.geometry.location.lat();
      selectedLng   = place.geometry.location.lng();

      uploadMap.setCenter(place.geometry.location);
      uploadMap.setZoom(15);

      if (uploadMarker) uploadMarker.setMap(null);
      uploadMarker = new google.maps.Marker({
        map: uploadMap,
        position: place.geometry.location,
        title: selectedPlace,
        animation: google.maps.Animation.DROP
      });

      const infoWindow = new google.maps.InfoWindow({
        content: `<div style="font-weight:600;color:#006AFF;padding:4px;">${selectedPlace}</div>`
      });
      infoWindow.open(uploadMap, uploadMarker);
    });
  }

  // Init map when API ready
  if (window.mapsReady) {
    initUploadMap();
  } else {
    window.pendingMapInit = initUploadMap;
  }

  // ‚îÄ‚îÄ Form Submit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const submitBtn = document.getElementById("submit-btn");

  document.getElementById("upload-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const title       = document.getElementById("title").value.trim();
    const category    = document.getElementById("category").value;
    const price       = document.getElementById("price").value.trim();
    const description = document.getElementById("description").value.trim();
    const contact     = document.getElementById("contact").value.trim();

    if (!title || !category || !price || !description) {
      showToast("Please fill in all required fields.", "error");
      return;
    }

    submitBtn.disabled    = true;
    submitBtn.innerHTML   = `<div class="spinner" style="width:18px;height:18px;border-width:3px;"></div> Uploading‚Ä¶`;
    showToast("Uploading your listing‚Ä¶", "info");

    try {
      let imageUrls = [];
      if (selectedFiles.length > 0) {
        imageUrls = await uploadImages(selectedFiles, "listings");
      }

      const id = await addListing({
        title, category, price, description, contact,
        images:       imageUrls,
        locationName: selectedPlace || document.getElementById("location-input").value.trim(),
        lat:          selectedLat,
        lng:          selectedLng
      });

      showToast("üéâ Listing posted successfully!", "success");
      setTimeout(() => { window.location.href = `listing.html?id=${id}`; }, 1500);
    } catch (err) {
      console.error(err);
      showToast(err.message || "Failed to post listing.", "error");
      submitBtn.disabled    = false;
      submitBtn.innerHTML   = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 2L11 13"/><path d="M22 2L15 22 11 13 2 9l20-7z"/></svg> Post Listing`;
    }
  });

  // ‚îÄ‚îÄ Toast Helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function showToast(message, type = "info") {
    const existing = document.querySelector(".toast");
    if (existing) existing.remove();
    const toast = document.createElement("div");
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.classList.add("toast-visible"), 50);
    setTimeout(() => {
      toast.classList.remove("toast-visible");
      setTimeout(() => toast.remove(), 400);
    }, 3500);
  }
</script>
</body>
</html>
